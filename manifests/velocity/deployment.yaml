apiVersion: apps/v1
kind: Deployment
metadata:
  name: velocity-proxy
  namespace: minecraft
  labels:
    app: velocity-proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: velocity-proxy
  template:
    metadata:
      labels:
        app: velocity-proxy
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # Init containers: copy config and plugins to writable volumes
      initContainers:
        - name: copy-config
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              cp /config-readonly/velocity.toml /app-config/velocity.toml
              cp /secret-readonly/forwarding.secret /app-config/forwarding.secret
              chmod 644 /app-config/velocity.toml
              chmod 600 /app-config/forwarding.secret
          volumeMounts:
            - name: config-readonly
              mountPath: /config-readonly
            - name: secret-readonly
              mountPath: /secret-readonly
            - name: app-config
              mountPath: /app-config
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            capabilities:
              drop: ["ALL"]

      containers:
        - name: velocity
          image: ghcr.io/willgriffin/minecraft/velocity:latest
          ports:
            - containerPort: 25565
              name: java
              protocol: TCP
            - containerPort: 19132
              name: bedrock
              protocol: UDP
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false  # Velocity needs to write plugin data
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: app-config
              mountPath: /app/velocity.toml
              subPath: velocity.toml
            - name: app-config
              mountPath: /app/forwarding.secret
              subPath: forwarding.secret
            - name: tmp
              mountPath: /tmp
            - name: logs
              mountPath: /app/logs
            - name: lang
              mountPath: /app/lang
            - name: bstats
              mountPath: /app/plugins/bstats
            - name: geyser-data
              mountPath: /app/plugins/Geyser-Velocity
            - name: floodgate-data
              mountPath: /app/plugins/floodgate
          livenessProbe:
            tcpSocket:
              port: 25565
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 25565
            initialDelaySeconds: 10
            periodSeconds: 5

      volumes:
        - name: config-readonly
          configMap:
            name: velocity-config
        - name: secret-readonly
          secret:
            secretName: velocity-forwarding
        - name: app-config
          emptyDir: {}
        - name: tmp
          emptyDir: {}
        - name: logs
          emptyDir: {}
        - name: lang
          emptyDir: {}
        - name: bstats
          emptyDir: {}
        - name: geyser-data
          emptyDir: {}
        - name: floodgate-data
          emptyDir: {}
